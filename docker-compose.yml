version: '3.7'

services:
  # ğŸ†• Spring Boot ì• í”Œë¦¬ì¼€ì´ì…˜ ì„œë¹„ìŠ¤ ì¶”ê°€
  rento-app:
    build: .
    container_name: rento-app
    ports:
      - "8080:8080"
    volumes:
      - ./logs:/logs  # ë¡œì»¬ logs í´ë”ì™€ ì»¨í…Œì´ë„ˆ /logs í´ë” ì—°ê²°
    environment:
      - SPRING_PROFILES_ACTIVE=deploy
      # OpenTelemetry í™˜ê²½ë³€ìˆ˜ (Java Agentê°€ ìë™ìœ¼ë¡œ ì¸ì‹)
      - OTEL_SERVICE_NAME=rento-service
      - OTEL_EXPORTER_OTLP_ENDPOINT=http://tempo:4317
      - OTEL_EXPORTER_OTLP_PROTOCOL=grpc
      - OTEL_TRACES_EXPORTER=otlp
      - OTEL_METRICS_EXPORTER=none  # ğŸ”¥ ì´ê²Œ í•µì‹¬! TempoëŠ” metricsë¥¼ ë°›ì§€ ì•ŠìŒ
      - OTEL_LOGS_EXPORTER=none     # ğŸ”¥ ì´ê²ƒë„ ì¤‘ìš”! ë¡œê·¸ëŠ” Lokië¡œ ë³´ë‚´ì•¼ í•¨
      # Spring Boot Actuator tracing ì„¤ì •
      - MANAGEMENT_TRACING_SAMPLING_PROBABILITY=1.0
      - MANAGEMENT_OTLP_TRACING_ENDPOINT=http://tempo:4317
    networks:
      - monitor-net
    depends_on:
      tempo:
        condition: service_started
      mysql:
        condition: service_healthy
    extra_hosts:
      - "host.docker.internal:host-gateway"
    restart: unless-stopped

  prometheus:
    image: prom/prometheus
    container_name: prometheus
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
    ports:
      - "9090:9090"
    networks:
      - monitor-net

  grafana:
    image: grafana/grafana
    container_name: grafana
    volumes:
      - ./grafana/provisioning/datasources:/etc/grafana/provisioning/datasources
      - ./grafana/provisioning/dashboards:/etc/grafana/provisioning/dashboards

    ports:
      - "3000:3000"
    networks:
      - monitor-net
    depends_on:
      - prometheus
      - loki
      - tempo
    user: "1000" # Grafanaê°€ íŒŒì¼ì„ ì½ì„ ìˆ˜ ìˆë„ë¡ ê¶Œí•œ ì„¤ì •

  loki:
    image: grafana/loki
    container_name: loki
    volumes:
      - ./loki/loki-config.yml:/etc/loki/config.yml
      - ./loki/data:/tmp/loki
    ports:
      - "3100:3100"
    command: --config.file=/etc/loki/config.yml
    networks:
      - monitor-net
    user: "root"

  promtail:
    image: grafana/promtail
    container_name: promtail
    volumes:
      - ./promtail/promtail-config.yml:/etc/promtail/config.yml
      # Spring Boot ì• í”Œë¦¬ì¼€ì´ì…˜ì˜ ë¡œê·¸ê°€ ìˆëŠ” ë””ë ‰í† ë¦¬ë¥¼ ë§ˆìš´íŠ¸
      - ./logs:/logs
    command: --config.file=/etc/promtail/config.yml
    networks:
      - monitor-net
    depends_on:
      - rento-app

  tempo:
    image: grafana/tempo:2.8.0
    container_name: tempo
    command: [ "-config.file=/etc/tempo-config.yml" ]
    volumes:
      - ./tempo/tempo-config.yml:/etc/tempo-config.yml
      - ./tempo/data:/var/tempo
    ports:
      - "14268:14268" # Jaeger-Thrift HTTP
      - "4317:4317" # OTLP gRPC
      - "4318:4318" # OTLP HTTP
      - "3200:3200"
      - "9091:9091"
    networks:
      - monitor-net

  mysql:
    image: mysql:8.0
    container_name: mysql
    environment:
      - MYSQL_ROOT_PASSWORD=1234
      - MYSQL_DATABASE=rento
    ports:
      - "3306:3306"
    volumes:
      - ./mysql/data:/var/lib/mysql
    networks:
      - monitor-net
    # ğŸ†• healthcheck ì„¤ì • ì¶”ê°€
    healthcheck:
      test: [ "CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-p1234" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

networks:
  monitor-net:
    driver: bridge